<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>订单支付</title>
        <!--<link href="__PUBLIC__/static/css/order/public.css" type="text/css" rel="stylesheet"/>-->
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/static/css/index.css"/>
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/static/css/order/buyConfirm.css" />
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/static/css/order/base.css"/>
    <script src="__PUBLIC__/static/js/jquery/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="__PUBLIC__/static/css/base.css" type="text/css">
</head>

<body>
 <include file="public/indexhead"/>
    
    
 <!--订单提交body部分开始-->  


<div class="border_top_cart">

        <div class="container payment-con">
    <form  id="pay-form" method="post">
        <input type="hidden" name="orderid" value="{$order.id}"/>
            <div class="order-info">
                <div class="msg">
                    <h3>您的订单已提交成功！请您尽快付款！</h3>
                    <p></p>
                    <p class="post-date">成功付款后，请耐心等待发货</p>
                </div>
                <div class="info">
                        <p>订单：{$order.order_sn}&nbsp&nbsp&nbsp|&nbsp&nbsp&nbsp付款金额（元）：<span class="pay-total">{$order.order_amount}元</span></p>

                        <!--<p>配送：潘骏杰-->
                            <!--<span class="line">/</span>159****6437-->
                            <!--<span class="line">/</span>-->
                            <!--江苏,无锡市,北塘区 民丰西苑82号202室-->
                            <!--<span class="line">/</span>-->
                            <!--不限送货时间-->
                            <!--<span class="line">/</span>-->
                            <!--个人电子发票-->
                        <!--</p>-->
                </div>
                <div class="icon-box">
                    <i class="iconfont"><img src="__PUBLIC__/static/images/order/images/yes_ok.png"></i>
                </div>
            </div>
            
            <div class="xm-plain-box">
                <!-- 选择支付方式 -->
                <div class="box-hd bank-title clearfix">
                    <div id="titleWrap" class="title-wrap">
                        <h2 class="title">选择支付方式</h2>
                        <h2 class="title hide " >你还需要继续支付 <em>49.00</em> 元</h2>
                        <span class="tip-tag"></span>
                    </div>
                </div>
                <div class="box-bd" id="bankList">
                    <div class="payment-bd">
                    <dl class="clearfix payment-box" >
                    <dt>
                        <strong>支付平台</strong>
                        <p>手机等大额支付推荐使用支付宝快捷支付</p>
                    </dt>
                        <dd>
                            <fieldset id="test4-input-input_tab1-input_tab2" style=" border:none;">
                            <ul class="payment-list clearfix" >
                                <li id="paytype">
                                    <input class="input_tab" name="Paytype" id="r1" type="radio" value="1" />
                                    <label for="r1" ><img src="__PUBLIC__/static/images/order/images/yck.png" alt=""/></label>
                                </li>
                               <li id="paytype">
                                   <input class="input_tab" name="Paytype" id="r2" type="radio" value="2"  />
                                   <label for="r2" ><img src="__PUBLIC__/static/images/order/wx_logo.jpg" alt=""/></label></label>
                               </li>
                                <li id="paytype">
                                    <input class="input_tab" name="Paytype" id="r3" type="radio" value="3"  />
                                    <label for="r3" ><img src="__PUBLIC__/static/images/order/images/zfb.png" alt=""/></label>
                                </li>
                               <!--<li>  <input class="input_tab2" name="myradio" id="r4" type="radio" /><label for="r4" ><img src="__PUBLIC__/static/images/order/images/zxzf.png" alt=""/></label></li>-->
                             </ul>
                             </fieldset>
                        </dd>
                        </dl>
                    </div>
                            </div>
            <div class="box-ft clearfix">
                    <input type="button" class="btn btn-primary" value="下一步" id="payBtn">
                    <span class="tip"></span>
                </div>
            </div>
    </form>
</div>
<!-- 支付弹框 -->
<div class="modal hidden  to-pay-tip" id="toPayTip">
    <div class="modal-body" style="display: none;">
        <div class="close"></div>
        <div class="pay-tip clearfix">
            <div class="success">
                <h4>支付成功了</h4>
                <p>立即查看<a href="#" target="_blank">订单详情 &gt;</a></p>
            </div>
        </div>
    </div>
</div>
<!-- 余额支付弹框 -->
<div class="modal balance-pay" id="balancePay">
    <div class="shadow">
        <div class="modal-body" style="display: none;">
            <div class="close"></div>
            <if condition="$user.paypwd neq ''">
                <h3>付款金额：<span class="num"><em id="useCashAccountPayLeft">{$order.order_amount}</em>元</span></h3>
                <p id="checkCodeTip">您的账户余额：<span class="num"><em style="color: red;font-size: 14px;">{$user.user_money}</em>元</span></p>
                <input type="hidden" name="status" value="1"/>
                <input type="password" name="Newpaypwd[first]" maxlength="6" oninput = "value=value.replace(/[^\d]/g,'')" id="paypwd" class="input" placeholder="请输入支付密码">
               <span class="send-again" id="forgetpwd">忘记支付密码<em></em></span>
                <p><input type="button" value="确认支付" class="btn btn-primary" id="toPay">
                <else/>

               <h4 style="margin-top: 5px;">你还没设置支付密码</h4>
               <input type="password" name="Newpaypwd[first]" maxlength="6" oninput = "value=value.replace(/[^\d]/g,'')" class="input" placeholder="请输入6位纯数字支付密码">
               <span class="red" style="font-size: 13px" id="paypwdfirstcheck"><em></em></span>
               <input type="password" name="Newpaypwd[second]"  maxlength="6" oninput = "value=value.replace(/[^\d]/g,'')" class="input" placeholder="请再次输入支付密码">
               <span class="red" style="font-size: 13px" id="paypwdcheck"><em></em></span>
                   <if condition="$user.user_phone eq ''">
                       <h4 style="margin-top: 5px;">你还没绑定手机号码</h4>
                       <input type="hidden" name="status" value="2"/>
                       <input type="text" name="phone" maxlength="11" oninput = "value=value.replace(/[^\d]/g,'')"  class="input" placeholder="请输入接收短信的手机号">
                       <span class="send-again" id="sendmessage">发送手机验证码<em></em></span>
                       <input type="text" name="code"  maxlength="4" oninput = "value=value.replace(/[^\d]/g,'')"  id="code" class="input" placeholder="请输入验证码">

                   </if>
                <p><input type="button" value="提交" class="btn btn-primary" id="toPay">
           </if>



        </div>
    </div>
</div>




   
</div>

<include file="public/footer"/>

</body>
<script type="text/javascript">
   //判断支付密码输入
       $("input[name='Newpaypwd[first]']").blur(function () {
           var pwdfirst =  $(this).val().trim();
           if(pwdfirst.length!=6){
               $('#paypwdfirstcheck').html('请输入6位支付密码!');
           }else {
               $('#paypwdfirstcheck').html('');
           }
       })

       $("input[name='Newpaypwd[second]']").blur(function () {
           var pwdfirst = $("input[name='Newpaypwd[first]']").val();
           var pwdsecond = $("input[name='Newpaypwd[second]']").val();
           if (pwdfirst!=pwdsecond){
               $('#paypwdcheck').html('两次输入的密码必须相同!');
           }else {
               $('#paypwdcheck').html('');
           }

       })


    //默认让支付方式第一个选中
    function initFirstPaytype() {
        $('#paytype').each(function (i, o) {
            var firstPayRadio = $(this).find("input[type='radio']").eq(0);
            firstPayRadio.attr('checked', 'checked').prop('checked', true);
        })
    }
    initFirstPaytype();

    //点击切换支付方式
    $(document).on('click','#paytype',function () {
        $(this).find("input[name='Paytype']").attr('checked','checked');
        $(this).siblings().children('input').removeAttr('checked');
    });

    //点击下一步
    $(document).on('click','#payBtn',function () {
       var Paytype= $("input[name='Paytype']").val();
        if (Paytype==1){
            $('#balancePay').removeClass('modal');
            $('.modal-body').css('display','block')
        }
    })
    //点击close关闭弹窗
    $(document).on('click','.close',function () {
        $('#balancePay').addClass('modal');
        $('.modal-body').css('display','none');
    })
    //点击发送短信
    $(document).on('click','#sendmessage',function () {
        var phone = $(this).siblings("input[name='phone']").val();
        var status = $(this).siblings("input[name='status']").val();
        // console.log(status);
        $.ajax({
            type: "POST",
            url: "/Index/User/test",
            data: {
                'phone':phone,
                'status':status
            },
            async: false,
            dataType:'json',
            success: function(data){
                if (data.status == 0){
                    alert( '短信发送次数已达上限，请明天再来！   ' );
                }
                if(data.status == 1){
                    alert( '短信发送成功');
                }
                if (data.status == 3){
                    alert( data.msg );
                }

            },
            error : function(XMLHttpRequest, textStatus, errorThrown) {
                alert("网络失败，请刷新页面后重试!");
            }
        });
    })

    //点击确认支付
    $(document).on('click','#toPay',function () {
        var phone = $("input[name='phone']").val();
        var status = $("input[name='status']").val();
        var pwdfirst = $("input[name='Newpaypwd[first]']").val();
        var pwdsecond = $("input[name='Newpaypwd[second]']").val();
        var code = $("input[name='code']").val();
        var orderid = $("input[name='orderid']").val();
        if (status==2){
            if (pwdfirst!=pwdsecond){
                $('#paypwdcheck').html('两次输入的密码必须相同!');
                return false;
            }else if(pwdfirst==''){
                $('#paypwdfirstcheck').html('密码不能为空!');
            }else if(pwdsecond==''){
                $('#paypwdcheck').html('密码不能为空!');
            }
        }
            $('#paypwdcheck').html('');
            $('#paypwdfirstcheck').html('');
                $.ajax({
                    type: "POST",
                    url: "/Index/Order/toPay",
                    data: {
                        'phone':phone,
                        'status':status,
                        'pwdfirst':pwdfirst,
                        'pwdsecond':pwdsecond,
                        'code':code,
                        'orderid':orderid,
                    },
                    async: false,
                    dataType:'json',
                    success: function(data){
                        if (data.status == -100){
                            alert(data.msg);
                        }
                        if(data.status == 200){
                            alert( data.msg);
                            location.reload();
                            $('#balancePay').removeClass('modal');
                            $('.modal-body').css('display','block')
                        }
                        if(data.status == 300){
                            alert( data.msg);
                            $('#toPayTip').removeClass('hide');
                           $('.close').trigger('click');
                        }


                    },
                    error : function(XMLHttpRequest, textStatus, errorThrown) {
                        alert("网络失败，请刷新页面后重试!");
                    }
                });



    })

</script>
</html>
